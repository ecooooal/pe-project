{% from 'components/core/show-header' import show_header %}
{% from '/components/core/header-item' import header_item %}

{% import 'components/core/forms' as forms %}

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCoU2CNJ_dZNOtoslf5Lt8lAXwhfaZuBvY",
  authDomain: "pe-project-831e1.firebaseapp.com",
  projectId: "pe-project-831e1",
  storageBucket: "pe-project-831e1.firebasestorage.app",
  messagingSenderId: "17747378201",
  appId: "1:17747378201:web:ee3dbbee143f0781fe2a88",
  measurementId: "G-WDT4XLHRKD"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  window.googleLogin = async function() {
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const idToken = await user.getIdToken();

      const response = await fetch("/firebase-login", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-TOKEN": "{{ csrf_token() }}"
        },
        body: JSON.stringify({ idToken })
      });

      if (response.ok) {
        window.location.reload();
      } else {
        console.error("Login failed:", await response.text());
      }
    } catch (error) {
      console.error("Firebase Login Error:", error);
      alert(error.message);
    }
  };
</script>



<div class="bg-blue-900 px-4 flex items-center h-20 justify-between">
  <div class="flex items-center gap-x-3 group">
    <a href="/" class="mx-auto">
      <img class="object-cover w-12 h-12 mx-1" src="{{ asset('images/PCU_logo.png') }}">
    </a>
    <h1 class="text-white text-2xl font-semibold hover:text-blue-400 group-hover:text-blue-400 delay-100 duration-300">
      Application Name Here
    </h1>
    <p class="text-gray-300 text-xs font-semibold mt-2">S.Y 2025-2026</p>
  </div>

  <div class="flex gap-2 items-center">
    {% if auth_user() %}
      <!-- logged-in state here -->
      <form method="POST" action="/logout">
        {{ csrf_field() }}
        <button type="submit" class="text-white font-medium cursor-pointer">Logout</button>
      </form>
    {% endif %}

    {% if auth_guest() %}
      <button popovertarget="login-popover" class="text-white font-medium cursor-pointer">
        Login
      </button>
    {% endif %}
  </div>
</div>
{% if auth_guest() %}
  <div popover="manual" class="backdrop:bg-gray-900/15 backdrop:backdrop-blur-[1px] m-auto p-16 rounded-xl" id="login-popover">
    <div class="flex flex-col gap-y-4">
      {{ show_header('Login') }}
      <div class="flex">
        <!--  Firebase Login Button -->
        <a href="#" onclick="googleLogin()" class="mx-auto border-green-500 border-2 px-6 py-2 rounded-xl text-green-700 font-semibold hover:bg-green-600 hover:text-white transition">
          Google Sign In
        </a>
      </div>


             <div class="flex flex-1 flex-col">
        <form action="/login" method="POST" class="flex flex-col gap-y-4">
          {{ csrf_field() }}
          <div class="flex flex-col gap-y-4 w-full">
            {{ forms.form_field(
              label: forms.label(id:'email', content:'Faculty Email', attributes:{'class':'text-sm font-medium text-gray-900 after:text-red-500 after:content-[\'*\']'}),
              input: forms.email(name:'email', value: old('email'), attributes:{
                'class':'block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:outline-indigo-600 sm:text-sm',
                'required':true
              }),
              isColumn:true
            ) }}

            {{ forms.form_field(
              label: forms.label(id:'password', content:'Password', attributes:{'class':'text-sm font-medium text-gray-900 after:text-red-500 after:content-[\'*\']'}),
              input: forms.password(name:'password', values:values, attributes:{
                'class':'block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:outline-indigo-600 sm:text-sm',
                'placeholder':'*********',
                'required':true
              }),
              isColumn:true
            ) }}
          </div>

          {% if errors is not empty %}
            <div class="flex gap-x-2">
              {% for error in errors.get('email') %}
                <p class="text-red-500 font-medium text-sm mx-auto">{{ error }}</p>
              {% endfor %}
            </div>
          {% endif %}

          <div class="flex gap-x-2">
            <button type="submit" class="mx-auto px-32 bg-blue-900 text-gray-200 hover:bg-blue-600 hover:text-white rounded-lg py-2 font-semibold text-sm">
              Login
            </button>
          </div>
        </form>
      </div>
    </div>
        
        <button popovertarget="login-popover" popovertargetaction="hide" class="absolute right-0 top-0 pt-4 pr-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>          
        </button>
    </div>
{% endif %}

  