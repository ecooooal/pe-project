{% from 'components/core/show-header' import show_header %}
{% from '/components/core/header-item' import header_item %}
{% import 'components/core/forms' as forms %}

<div class="bg-blue-900 px-4 flex items-center h-20 justify-between">
    <div class="flex items-center gap-x-3 group">        
        <a href="/" class="mx-auto">
            <img class="object-cover w-12 h-12 mx-1" src="{{ asset('images/PCU_logo.png') }}">
        </a>
        <h1 class="text-white text-2xl font-semibold hover:text-blue-400 group-hover:text-blue-400 delay-100 duration-300">
            PCU Proficiency Examination Application
        </h1>
        {{ csrf_field() }}
        {% if auth_user() %}
            <p class="{{ current_academic_year ? 'text-gray-300' : 'text-red-300' }} text-xs font-semibold mt-2">(Dasmarinas) {{ current_academic_year ? 'S.Y' : '' }} {{ current_academic_year ?? 'MAINTENANCE' }}</p>
        {% endif %}
    </div> 

    <div class="flex gap-2 items-center">
        {% if auth_user() %}
            {% if auth_user().can('view student') %}
                {{ header_item('/student', 
                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6"><path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z" /><path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z" /></svg>',
                    'Home', false)}} 
            {% endif %}
            <form method="POST" action="/logout">
                {{ csrf_field() }}
                <button type="submit" class="text-white font-medium cursor-pointer">Logout</button>
            </form>          
        {% endif %}
        {% if auth_guest() %}
            <button id="login-btn" type="button" class="text-white font-medium cursor-pointer">
                Login
            </button>
        {% endif %}
    </div>
</div>

{% if auth_guest() %}
    {# Consent popover shown BEFORE login-popover #}
    <div popover="manual"
         id="consent-popover"
         class="backdrop:bg-gray-900/40 backdrop:backdrop-blur-md m-auto max-w-xl p-8 rounded-xl bg-white shadow-xl space-y-4 relative">
        <h2 class="text-lg font-semibold text-gray-900">
            Data Privacy &amp; Consent
        </h2>

        <p class="text-sm text-gray-700">
            By continuing, you agree that PCU may collect and process your school data
            for the purpose of managing the Proficiency Examination application, in accordance with our Data Privacy Policy.
            Rest assure that your grades won't be affected by this examination.
        </p>

        <div class="flex justify-end gap-3 pt-4">
            <button id="consent-decline"
                    type="button"
                    class="px-4 py-2 text-sm rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">
                Cancel
            </button>
            <button id="consent-accept"
                    type="button"
                    class="px-4 py-2 text-sm rounded-md bg-blue-900 text-white hover:bg-blue-700">
                I Agree
            </button>
        </div>

        <button popovertarget="consent-popover"
                popovertargetaction="hide"
                type="button"
                class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                 viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <div popover="manual" class="backdrop:bg-gray-900/15 backdrop:backdrop-blur-[1px] m-auto p-16 rounded-xl" id="login-popover">
        <div class="flex flex-col gap-y-4">
            {{ show_header('Login with PCU Account') }}
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline" id="error-text"></span>
            </div>
            
            <div id="loading-message" class="hidden text-center py-4">
                <p class="text-gray-600">Signing in...</p>
            </div>

            <div class="flex flex-col gap-y-4">
                <button id="google-signin-btn" 
                        class="mx-auto px-8 py-3 bg-white hover:bg-gray-100 text-gray-800 font-semibold rounded-lg border border-gray-300 shadow-sm transition duration-300 flex items-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>
                
                <p class="text-center text-sm text-gray-600">
                    Please use your @pcu.edu.ph email
                </p>
            </div>
        </div>

        <div class="flex flex-1 flex-col">
            <form action="/login" method="POST" class="flex flex-col gap-y-4">
                {{ csrf_field() }}
                <div class="flex gap-x-32 justify-between w-full">
                    <div class="flex flex-col gap-y-4 w-full">
                        {{ forms.form_field(
                            label:forms.label(
                                id:'email', 
                                content:'Faculty Email', 
                                attributes:{
                                    'class':'whitespace-nowrap text-sm/6 font-medium text-gray-900  after:text-red-500 after:content_[\'\*\']'}
                            ),
                            input:forms.email(
                                name:'email', 
                                value: old('email'),
                                attributes:{
                                    'class':'block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6',
                                    'required':true,}
                            ),
                            isColumn:true 
                        ) }}
                        {{ forms.form_field(
                            label:forms.label(
                                id:'password', 
                                content:'Password', 
                                attributes:{
                                    'class':'whitespace-nowrap text-sm/6 font-medium text-gray-900 after:text-red-500 after:content_[\'\*\']'}
                                    ),
                            input:forms.password(
                                name:'password', 
                                values:values, 
                                attributes:{
                                    'class':'flex-1 cursor-pointer block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6',
                                    'placeholder':'*******',
                                    'required':true}
                            ),
                            isColumn:true 
                        ) }}
                    </div>
                </div>

                {% if errors is not empty %}
                    <div class="flex gap-x-2">
                        {% for error in errors.get('email') %}
                            <p class="text-red-500 font-medium text-sm mx-auto">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
                <div class="flex gap-x-2">
                    <button type="submit" class="mx-auto px-32 cursor-pointer bg-blue-900 text-gray-200 hover:bg-blue-600 hover:text-white duration-300 rounded-lg py-2 font-semibold text-sm">Login</button>
                </div>
            </form>
        </div>

        {# Admin Login Form (Hidden by default) #}
        <div id="admin-login-section" class="hidden flex flex-col gap-y-4">
            <div class="flex flex-col gap-y-4 w-full">
                <p class="text-center text-sm text-gray-700 mb-4">Admin Access for Testing</p>
                
                <a href="/faculty" class="mx-auto px-32 cursor-pointer bg-blue-900 text-gray-200 hover:bg-blue-600 hover:text-white duration-300 rounded-lg py-2 font-semibold text-sm text-center">
                    Go to Faculty Dashboard
                </a>
            </div>

            <button id="show-google-login" class="text-center text-xs text-gray-500 hover:text-gray-700 underline">
                Back to Google Sign-In
            </button>
        </div>
        
        <button popovertarget="login-popover" popovertargetaction="hide" class="absolute right-0 top-0 pt-4 pr-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>          
        </button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration - Replace with your actual config
        const firebaseConfig = {
            apiKey: "{{ firebase_config.api_key }}",
            authDomain: "{{ firebase_config.project_id }}.firebaseapp.com",
            projectId: "{{ firebase_config.project_id }}",
            storageBucket: "{{ firebase_config.project_id }}.firebasestorage.app",
            messagingSenderId: "{{ firebase_config.messaging_sender_id }}",
            appId: "{{ firebase_config.app_id }}"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({
            hd: 'pcu.edu.ph' // Restrict to PCU domain
        });

        const signInBtn = document.getElementById('google-signin-btn');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const loadingDiv = document.getElementById('loading-message');

        function showError(message) {
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            loadingDiv.classList.add('hidden');
        }

        function showLoading() {
            errorDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
        }

        signInBtn.addEventListener('click', async () => {
            showLoading();
            
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Check if email is from PCU domain
                if (!user.email.endsWith('@pcu.edu.ph')) {
                    showError('Please use your @pcu.edu.ph email address');
                    await auth.signOut();
                    return;
                }

                // Get ID token
                const idToken = await user.getIdToken();

                // Send to Laravel backend
                const response = await fetch('/auth/firebase/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('input[name="_token"]').value
                    },
                    body: JSON.stringify({ idToken })
                });

                const data = await response.json();

                if (response.ok) {
                    // Redirect based on role
                    window.location.href = data.redirect || '/';
                } else {
                    showError(data.error || 'Authentication failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError(error.message || 'An error occurred during sign in');
            }
        });
    </script>

    <script>
        (function () {
            const loginBtn        = document.getElementById('login-btn');
            const consentPopover  = document.getElementById('consent-popover');
            const loginPopover    = document.getElementById('login-popover');
            const consentAccept   = document.getElementById('consent-accept');
            const consentDecline  = document.getElementById('consent-decline');

            if (!loginBtn || !consentPopover || !loginPopover) return;

            const CONSENT_KEY = 'pcu-data-consent-v1';

            function hasConsent() {
                try {
                    return localStorage.getItem(CONSENT_KEY) === 'true';
                } catch (e) {
                    // If localStorage is blocked, just fall back to showing consent every time
                    return false;
                }
            }

            function setConsent(value) {
                try {
                    localStorage.setItem(CONSENT_KEY, value ? 'true' : 'false');
                } catch (e) {
                    // ignore
                }
            }

            function openLoginPopover() {
                if (typeof loginPopover.showPopover === 'function') {
                    loginPopover.showPopover();
                }
            }

            function openConsentPopover() {
                if (typeof consentPopover.showPopover === 'function') {
                    consentPopover.showPopover();
                }
            }

            // When the user clicks "Login"
            loginBtn.addEventListener('click', function () {
                if (hasConsent()) {
                    // User already agreed before → go straight to login popover
                    openLoginPopover();
                } else {
                    // First time or no stored consent → show consent first
                    openConsentPopover();
                }
            });

            // User agrees to data usage
            consentAccept.addEventListener('click', function () {
                setConsent(true);
                if (typeof consentPopover.hidePopover === 'function') {
                    consentPopover.hidePopover();
                }
                openLoginPopover();
            });

            // User cancels / declines
            consentDecline.addEventListener('click', function () {
                setConsent(false);
                if (typeof consentPopover.hidePopover === 'function') {
                    consentPopover.hidePopover();
                }
                // Do NOT open login popover
            });
        })();
    </script>
{% endif %}